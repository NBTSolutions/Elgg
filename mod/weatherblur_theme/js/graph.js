
// ../js/namespace.js
wb={graph:{model:{},assets:{},constants:{}}};

// ../js/model/Constants.js
moment.defaultFormat="YYYY-MM-DD",wb.graph.aggregatorUrl="localhost";

// ../js/component/GraphView.js
enyo.kind({name:"wb.GraphView",published:{marginTop:20,marginBottom:60,marginLeft:80,marginRight:80,yAxisOffset:15,pointRadius:6,selectedPointRadius:12},events:{onError:""},handlers:{onNewData:"handleNewData"},components:[{name:"dataPopup",kind:"nbt.DataPopup"}],rendered:function(){this.inherited(arguments)},getPlotWidth:function(){var t=this.hasNode();if(t){var a=this.getBounds();return a.width-this.marginLeft-this.marginRight}return 0},getPlotHeight:function(){var t=this.hasNode();if(t){var a=this.getBounds();return a.height-this.marginTop-this.marginBottom}return 0},handleNewData:function(t,a){a.data&&this.redrawGraph(a.data)},redrawGraph:function(t){if(!t.dates||!t.measurements||!t.measuredData)return this.doError({message:"Missing data, graph cannot be drawn, try again later"}),void 0;var a=t.measuredData,e=[t.dates.start,t.dates.end],i=d3.time.scale().domain(e).range([0,this.getPlotWidth()]);this.dateScale=i;var n=d3.time.hours;moment(e[1]).isAfter(moment(e[0]).add("days",1))?(this.scaleOffset=d3.time.day,n=d3.time.days):this.scaleOffset=d3.time.hour,d3.select("svg#wb-graph").remove();var s=d3.select("#"+this.id).append("svg:svg").attr("id","wb-graph").attr("width",this.getPlotWidth()+this.marginLeft+this.marginRight).attr("height",this.getPlotHeight()+this.marginTop+this.marginBottom).append("svg:g").attr("transform","translate("+this.marginRight+","+this.marginTop+")");this.plot=s;var r=d3.svg.axis().scale(i).orient("bottom").ticks(n,1).tickPadding(0).tickSubdivide(0).tickSize(-this.getPlotHeight());s.append("svg:g").attr("class","x_axis").attr("transform","translate(0, "+this.getPlotHeight()+")").call(r).call(enyo.bind(this,this.centerDateLabels)).selectAll("text").style("text-anchor","end").attr("dx","-.3em").attr("dy","0.35em");var o=["left","right"],d=0,h=enyo.bind(this,this.mouseOver),m=enyo.bind(this,this.mouseOut);_.each(a,enyo.bind(this,function(t,a){if(t.domain&&t.domain.length>0){var e=o[d%2];d++;var n=t.data,r=this.cleanDomain(t.domain),l=d3.scale.linear().domain(r).range([this.getPlotHeight(),0]),u=d3.svg.axis().scale(l).ticks(6).orient(e),c=-this.yAxisOffset,g=c-30,f=-90;"right"==e&&(c=this.yAxisOffset+this.getPlotWidth(),g=c+30,f=90),s.append("svg:g").attr("class","y_axis axis_"+e).attr("transform","translate("+c+", 0)").call(u),s.append("text").attr("class","y_label_"+e).attr("text-anchor","middle").attr("transform","translate("+g+", "+this.getPlotHeight()/2+") rotate("+f+")").text(t.title);var p=s.selectAll(a).data(n).enter().append("circle");p.attr("class","side_"+e).attr("cx",-100).attr("cy",-100).attr("r",this.pointRadius),p.transition().duration(500).each("end",function(){d3.select(this).on("mouseover",function(a,e){var i=d3.select(this);h(a,e,i,t.title,t.unit)}).on("mouseout",function(){m(this)})}).attr("cx",function(t){return i(new Date(t.timestamp))}).attr("cy",function(t){return l(t.value)})}}))},mouseOver:function(t,a,e,i,n){var s=parseFloat(e.attr("cx"))+this.marginRight+20,r=parseFloat(e.attr("cy"));d3.time.format("%c");var o=this.$.dataPopup;o.setValue(t.value),o.setTitle(i),o.setUnitLabel(n),o.setMoment(t.timestamp),o.showAtPosition({left:s,top:r}),e.transition().duration(200).attr("r",this.selectedPointRadius)},mouseOut:function(t){this.$.dataPopup.hide(),d3.select(t).transition().duration(200).attr("r",this.pointRadius)},formatYData:function(t){var a={};return _.each(t.data,enyo.bind(this,function(t){t.measurements&&_.each(t.measurements,enyo.bind(this,function(e){var i=e.phenomenon.name;a[i]&&(a[i].title=a[i].title||e.phenomenon.description,a[i].unit=a[i].unit||e.phenomenon.unit.name,a[i].data=a[i].data||[],a[i].data.push({timestamp:t.timestamp,value:e.value}),a[i].domain=a[i].domain||[],a[i].domain.push(e.value))}))})),a},getAxisDates:function(t){var a=moment(t.start),e=moment(t.end),t=[];if(e.isAfter(moment(a).add("days",2)))for(;a.isBefore(e);)t.length>0?t[1]=moment(a).endOf("day").toDate():t.push(moment(a).startOf("day").toDate()),a.add("days",1);return t},centerDateLabels:function(t){t.selectAll(".major text").attr("transform","translate("+this.dayToPixels()/2+",0) rotate(-90)")},dayToPixels:function(){var t=new Date;return this.dateScale(this.scaleOffset.offset(t,1))-this.dateScale(t)},cleanDomain:function(t){var a=1*d3.min(t),e=1*d3.max(t);if(100==e&&a>=0)return[a,e];var i=.1*(e-a);return a-=i,e+=i,[a,e]}});

// ../js/component/GraphControls.js
enyo.kind({name:"wb.GraphControls",published:{from:null,phenomena:null,measurements:[],maxMeasurements:2,startMoment:moment().subtract("days",1).startOf("day"),endMoment:moment().subtract("days",1).endOf("day")},events:{onError:"",onFromChanged:"",onRequestData:""},components:[{classes:"row",components:[{classes:"parameter-block",components:[{classes:"display",content:"From:"},{name:"fromDisplay",classes:"choice-display",ontap:"showPersonPicker",content:"Me"},{tag:"i",ontap:"showPersonPicker",classes:"icon-group elgg-button elgg-button-action"}]},{classes:"parameter-block",name:"startDate",components:[{classes:"display",content:"Start Date:"},{name:"startDateDisplay",classes:"choice-display",ontap:"showCalendar",content:""},{tag:"i",ontap:"showCalendar",classes:"icon-calendar elgg-button elgg-button-action"},{kind:"wb.DatePickCalendar",name:"startDateCalendar",floating:!1,centered:!1,showDatePicker:!1,onSelect:"dateSelected"}]},{classes:"parameter-block",name:"endDate",components:[{classes:"display",content:"End Date:"},{name:"endDateDisplay",classes:"choice-display",ontap:"showCalendar",content:""},{tag:"i",ontap:"showCalendar",classes:"icon-calendar elgg-button elgg-button-action"},{kind:"wb.DatePickCalendar",name:"endDateCalendar",floating:!1,centered:!1,showDatePicker:!1,onSelect:"dateSelected"}]}]},{classes:"row measure",components:[{tag:"h4",content:"Choose up to 2 Measures for Display"},{name:"measureBlock",classes:"measure-block"}]},{name:"toolbar",components:[{kind:"enyo.Button",classes:"elgg-button elgg-button-submit",ontap:"showGraph",content:"Show Graph"}]}],create:function(){this.inherited(arguments);var t=new wb.api.PhenomenonCollection;t&&t.fetch&&t.fetch({query:"byUomType",data:{type:"scalar"},success:enyo.bind(this,"setPhenomena")}),this.$.startDateCalendar.setDate(this.startMoment.toDate(),!0),this.$.startDateDisplay.setContent(this.startMoment.format()),this.$.endDateCalendar.setDate(this.endMoment.toDate(),!0),this.$.endDateDisplay.setContent(this.endMoment.format())},phenomenaChanged:function(){this.phenomena=_(this.phenomena.sortBy(function(t){return t.get("name")})),this.phenomena.each(function(t){"scalar"==t.get("unit").get("type")&&this.$.measureBlock.createComponent({kind:"nbt.Checkbox",text:t.get("description"),value:t.get("name"),checked:!1,ontap:"measurementToggled",owner:this})},this),this.$.measureBlock.render()},measurementToggled:function(t){if(this.measurements=this.measurements||[],this.measureTitles=this.measureTitles||{},t.checked?_.contains(this.measurements,t.value)||(this.measurements.push(t.value),this.measureTitles[t.value]=t.text):this.measurements=_.without(this.measurements,t.value),this.measurements.length>this.maxMeasurements){this.measurements=_.last(this.measurements,2);var e=this.$.measureBlock.getControls();_.each(e,enyo.bind(this,function(t){"nbt.Checkbox"!=t.kind||_.contains(this.measurements,t.getValue())||t.setChecked(!1)}))}},showPersonPicker:function(){if($){var t=$("#graph_people");1==t.length&&t.show()}},showCalendar:function(t){var e,a=t.parent.name,n=null;"startDate"==a?(e=this.$.startDateCalendar,n=this.$.endDateCalendar):"endDate"==a&&(e=this.$.endDateCalendar,n=this.$.startDateCalendar),e&&(e.showing?e.hide():e.show()),n&&n.hide()},dateSelected:function(t){if("startDateCalendar"==t.name){var e=moment(t.value).startOf("day");t.value=e.toDate(),this.$.startDateDisplay.setContent(e.format("YYYY-MM-DD")),this.startMoment=e;var a=moment(this.$.endDateCalendar.getValue());if(a.isBefore(e))a=moment(e).endOf("day"),this.$.endDateCalendar.setDate(a.toDate());else{var n=moment(e).add("months",1).endOf("day");moment(this.$.endDateCalendar.getValue()).isAfter(n)&&this.$.endDateCalendar.setDate(n.toDate())}this.$.startDateCalendar.hide()}else if("endDateCalendar"==t.name){var a=moment(t.value).endOf("day");t.value=a.toDate(),this.$.endDateDisplay.setContent(a.format("YYYY-MM-DD")),this.endMoment=a;var e=moment(this.$.startDateCalendar.getValue());if(e.isAfter(a))e=moment(a).startOf("day"),this.$.startDateCalendar.setDate(e.toDate());else{var s=moment(a).subtract("months",1).startOf("day");e.isBefore(s)&&this.$.startDateCalendar.setDate(s.toDate())}this.$.endDateCalendar.hide()}},showGraph:function(){var t=this.$.fromDisplay.hasNode().value;if(t||(t=window.uid||!1),!t)return this.doError({message:"Could not figure out who to retrieve data for"}),void 0;if(!this.measurements||0==this.measurements.length)return this.doError({message:"Please select at least 1 measure to be shown"}),void 0;var e={inDateRange:{begin:moment(this.startMoment).format(),end:moment(this.endMoment).format()},withPhenomena:this.measurements};this.doRequestData({data:e,user:t})}});

// ../js/component/Checkbox.js
enyo.kind({name:"nbt.Checkbox",classes:"nbt-checkbox",published:{text:"",value:"",checked:!0},events:{ontap:""},components:[{tag:"i",name:"checkbox",classes:"icon-check-empty",ontap:"tapped"},{name:"text",ontap:"tapped"}],create:function(){this.inherited(arguments),this.$.text.setContent(this.text),this.checkedChanged()},tapped:function(){this.setChecked(!this.checked)},checkedChanged:function(){var t=this.$.checkbox;this.checked?(t.removeClass("icon-check-empty"),t.addClass("icon-check")):(t.addClass("icon-check-empty"),t.removeClass("icon-check"))}});

// ../js/component/DatePickCalendar.js
enyo.kind({kind:"onyx.Popup",name:"wb.DatePickCalendar",published:{showDatePicker:!0,value:moment(),monthDisplayFormat:"MMMM"},events:{onSelect:""},centered:!0,floating:!0,scrim:!0,autoDismiss:!0,modal:!0,classes:"calendar-popup",components:[{name:"header",components:[{tag:"i",classes:"icon-circle-arrow-left",ontap:"prevMonth"},{name:"monthDisplay",content:"",showing:!1},{kind:"onyx.DatePicker",onSelect:"doPickerChanged"},{tag:"i",classes:"icon-circle-arrow-right",ontap:"nextMonth"}]},{kind:"CalendarSelector",onDaySet:"doCalendarChanged",onSelect:"selectDate"},{kind:"onyx.Button",content:" Cancel",classes:"icon-remove",ontap:"hide"},{kind:"onyx.Button",content:" Done",classes:"icon-ok",ontap:"doSaveAndHide"}],create:function(){this.inherited(arguments),this.showDatePicker||(this.$.button.hide(),this.$.button2.hide(),this.$.datePicker.hide(),this.$.monthDisplay.show(),this.updateMonthDisplay())},updateMonthDisplay:function(t){t||(t=this.value),this.$.monthDisplay.setContent(moment(t).format(this.monthDisplayFormat))},doCalendarChanged:function(t,e){var a=moment(t.getValue()),n=moment(e.control.getValue());a.isSame(n,"day")&&(_.each(t.getDays(),function(t){t.addRemoveClass("day-selected",!1)},this),e.control.addRemoveClass("day-selected",!0),this.showDatePicker&&this.$.datePicker.setValue(a.toDate()))},setDate:function(t,e){e?(this.value=t,this.$.calendarSelector.setValue(t),this.$.datePicker.setValue(t)):this.$.calendarSelector.calTap({value:t})},selectDate:function(t,e){return this.$.datePicker.setValue(e.value),this.showDatePicker||this.doSaveAndHide(),!0},doPickerChanged:function(t,e){this.$.calendarSelector.setValue(e.value)},nextMonth:function(){if(this.showDatePicker)this.$.calendarSelector.nextMonth();else{var t=moment(this.$.calendarSelector.getValue()).add("months",1);this.$.calendarSelector.setValue(t.toDate()),this.$.monthDisplay.setContent(t.format(this.monthDisplayFormat))}},prevMonth:function(){if(this.showDatePicker)this.$.calendarSelector.prevMonth();else{var t=moment(this.$.calendarSelector.getValue()).subtract("months",1);this.$.calendarSelector.setValue(t.toDate()),this.$.monthDisplay.setContent(t.format(this.monthDisplayFormat))}},doSaveAndHide:function(){this.value=this.$.datePicker.getValue(),this.doSelect({value:this.value}),this.hide()}});

// ../js/component/ModalMessagePopup.js
enyo.kind({name:"nbt.ModalMessagePopup",kind:"onyx.Popup",events:{onOk:"",onCancel:""},floating:!0,centered:!0,modal:!0,components:[{name:"message",allowHtml:!0,content:"Message"},{kind:"enyo.Button",name:"okButton",classes:"elgg-button elgg-button-action",ontap:"popupOk",components:[{tag:"i",classes:"icon-ok"},{content:"Ok"}]},{kind:"enyo.Button",name:"cancelButton",classes:"elgg-button elgg-button-action",ontap:"popupCancel",showing:!1,components:[{tag:"i",classes:"icon-ban-circle"},{content:"Cancel"}]}],showMessage:function(t,e){e=e||{},this.$.message.setContent(t),e.hideOk&&this.$.okButton.hide(),e.cancel&&this.$.cancelButton.show(),this.show()},popupOk:function(t){t.owner.doOk(),t.owner.hide()},popupCancel:function(t){t.owner.doCancel(),t.owner.hide()}});

// ../js/component/DataPopup.js
enyo.kind({name:"nbt.DataPopup",kind:"enyo.Popup",classes:"data_popup",published:{title:"",value:"",unitLabel:"",moment:""},components:[{name:"title"},{classes:"value",components:[{name:"value"},{name:"unit"}]},{name:"date"}],titleChanged:function(){this.$.title.setContent(this.title)},valueChanged:function(){this.$.value.setContent(this.value)},unitLabelChanged:function(){var t=this.convertUnitLabel(this.unitLabel);this.$.unit.setContent(t)},momentChanged:function(){this.$.date.setContent(moment(this.moment).format("ddd, MMM DD YYYY, h:mm:ss a"))},convertUnitLabel:function(t){return"FAHRENHEIT"==t.toUpperCase()?"\u00b0 F":"INCHES"==t.toUpperCase()?'"':t}});

// ../js/App.js
enyo.kind({name:"wb.Graph",published:{data:null,queryUrl:wb.graph.aggregatorUrl+"/observation/query",observations:null,retrievedMeasures:0},components:[{name:"header"},{kind:"wb.GraphView",onError:"showErrorMessage"},{kind:"wb.GraphControls",onRequestData:"doRequestData",onError:"showErrorMessage"},{name:"footer"},{name:"popup",kind:"nbt.ModalMessagePopup"},{kind:"enyo.Popup",name:"spinner",id:"graph-spinner",floating:!0,centered:!0,components:[{tag:"i",classes:"icon-spinner icon-spin"}]}],showErrorMessage:function(e,t){t.message&&this.$.popup.showMessage(t.message)},dataChanged:function(){this.waterfall("onNewData",{data:this.data})},doRequestData:function(e,t){this.showSpinner(),Backbone.Relational.store.reset(),(new wb.api.ObservationCollection).fetch({data:t.data,success:enyo.bind(this,function(e){if(0==e.length)this.showErrorMessage(this,{message:"No measurements matched your request.<br/>Please try again."}),this.hideSpinner();else if(t.user){var a=e.groupBy(function(e){return e.get("observer").get("elggId")}),n=new wb.api.ObservationCollection(a[t.user]);0==n.length?(this.showErrorMessage(this,{message:"No results matched your selected user.<br/>Please try again."}),this.hideSpinner()):this.setObservations(n)}else this.setObservations(e)})})},observationsChanged:function(){this.measuredData={};for(var e=0;this.$.graphControls.measurements.length>e;e++)this.measuredData[this.$.graphControls.measurements[e]]={};this.observations&&this.observations.length>0&&(this.retrievedMeasures=0,this.observations.each(enyo.bind(this,function(e){e.set({measurements:e.id}),e.fetchRelated("measurements",{success:enyo.bind(this,function(t){if(t.length>0&&(window.xxx=t,t.each(enyo.bind(this,function(t){if(t.get("class")&&"wb.api.Measurement"==t.get("class")){var a=t.get("phenomenon");if(a&&this.measuredData[a.get("name")]){var n=a.get("name");this.measuredData[n].title=this.measuredData[n].title||a.get("description"),this.measuredData[n].unit=this.measuredData[n].unit||a.get("unit").get("name"),this.measuredData[n].data=this.measuredData[n].data||[],this.measuredData[n].data.push({timestamp:e.get("timestamp"),value:t.get("value")}),this.measuredData[n].domain=this.measuredData[n].domain||[],this.measuredData[n].domain.push(t.get("value"))}}}))),this.retrievedMeasures++,this.retrievedMeasures==this.observations.length){this.hideSpinner();for(var a=[],n=0;this.$.graphControls.measurements.length>n;n++){var s=this.$.graphControls.measurements[n];0==_.keys(this.measuredData[s]).length&&a.push(this.$.graphControls.measureTitles[s])}a.length>0&&this.$.popup.showMessage("Sorry, we could find no data for<br/>"+a.join(" or ")+"<br/>that matched your request"),this.setData({dates:{start:this.$.graphControls.startMoment,end:this.$.graphControls.endMoment},measurements:this.$.graphControls.measurements,measuredData:this.measuredData})}})})})))},showSpinner:function(){this.$.spinner.show()},hideSpinner:function(){this.$.spinner.hide()}});

// machiapps/CalendarSelector/CalendarSelector.js
enyo.kind({name:"CalendarSelector",classes:"enyo-unselectable",published:{dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],value:new Date,dayColorDefault:"LightSlateGray",dayColorSelected:"Gold",dayColorToday:"GoldenRod",dayColorOtherMonth:"Silver",numberColorThisMonth:"#202020",numberColorOtherMonth:"dimgrey"},events:{onSelect:"",onDaySet:""},components:[{name:"day_names",classes:"top-day-box"},{fit:!0,name:"calVBox",kind:"CalMonth",style:"height: auto;"}],create:function(){this.inherited(arguments);for(var e=0;7>e;e++)this.$.day_names.createComponent({content:this.dayNames[e]})},rendered:function(){this.inherited(arguments),this.updateCalendar()},updateCalendar:function(){this.dayArray=[],this.getDays(),this.fillData()},fillData:function(){for(var e=this.$.calVBox.getControls(),t=0,a=0;e.length>a;a++)for(var n=e[a].getControls(),s=0;n.length>s;s++){n[s].setValue(this.dayArray[t]),n[s].setClassAttribute("");var o=this.getRelativeClass(this.dayArray[t]);n[s].addClass(o),t++,this.doDaySet({control:n[s]})}},getRelativeClass:function(e){if(e.getMonth()<this.value.getMonth())return"prev-month";if(e.getMonth()>this.value.getMonth())return"next-month";var t=new Date;return t.getFullYear()==e.getFullYear()&&t.getDate()==e.getDate()&&t.getMonth()==e.getMonth()?"today":"day"},getColors:function(e){var t=this.dayColorDefault,a=this.numberColorThisMonth,n=(new Date).getDate(),s=(new Date).getMonth(),o=(new Date).getFullYear();return e.getMonth()!=this.value.getMonth()?(t=this.dayColorOtherMonth,a=this.numberColorOtherMonth):this.value.getFullYear()==e.getFullYear()&&this.value.getDate()==e.getDate()&&this.value.getMonth()==e.getMonth()?t=this.dayColorSelected:o==e.getFullYear()&&n==e.getDate()&&s==e.getMonth()&&(t=this.dayColorToday),[t,a]},getDays:function(){var e=new Date(this.value);e.setDate(1);var t=e.getDay(),a=new Date(e);a.setDate(0);var n=a.getDate(),s=new Date(e);s.setMonth(e.getMonth()+1),s.setDate(0);var o=s.getDate(),r=n-t+1;for(i=0;t>i;i++)this.dayArray.push(new Date(a.getFullYear(),a.getMonth(),r,12,0,0)),r++;for(r=1;o>=r;)this.dayArray.push(new Date(s.getFullYear(),s.getMonth(),r,12,0,0)),r++;for(r=1,s.setDate(s.getDate()+1);42>this.dayArray.length;)this.dayArray.push(new Date(s.getFullYear(),s.getMonth(),r,12,0,0)),r++},calTap:function(e){this.value=e.value,this.updateCalendar(),this.doSelect({value:this.value})},setValue:function(e){this.value=new Date(e),this.updateCalendar()},nextMonth:function(){var e=this.value.getDate();this.value.setMonth(this.value.getMonth()+1),e!=this.value.getDate()&&this.value.setDate(0),this.updateCalendar(),this.doSelect({value:this.value})},prevMonth:function(){var e=this.value.getDate();this.value.setMonth(this.value.getMonth()-1),e!=this.value.getDate()&&this.value.setDate(0),this.updateCalendar(),this.doSelect({value:this.value})}}),enyo.kind({name:"CalDay",classes:"day-container",published:{value:{}},events:{onDayPicked:""},handlers:{ontap:"tapMe"},valueChanged:function(){this.setContent(this.value.getDate())},setValue:function(e){this.value=e,this.valueChanged()},tapMe:function(){return this.owner.owner.owner.calTap({value:this.value}),this.doDayPicked({day:this}),!0}}),enyo.kind({name:"CalWeek",classes:"onyx-toolbar-inline week-container",defaultKind:"CalDay",components:[{},{},{},{},{},{},{}]}),enyo.kind({name:"CalMonth",defaultKind:"CalWeek",components:[{},{},{},{},{},{}]});
