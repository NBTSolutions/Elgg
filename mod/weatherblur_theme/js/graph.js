
// ../js/namespace.js
wb={graph:{model:{},assets:{},constants:{}}};

// ../js/model/Constants.js
moment.defaultFormat="YYYY-MM-DD",wb.graph.aggregatorUrl="localhost";

// ../js/component/GraphView.js
enyo.kind({name:"wb.GraphView",published:{marginTop:20,marginBottom:60,marginLeft:80,marginRight:80,yAxisOffset:15,pointRadius:6,selectedPointRadius:12},handlers:{onNewData:"handleNewData"},components:[{name:"dataPopup",kind:"nbt.DataPopup"}],rendered:function(){this.inherited(arguments)},getPlotWidth:function(){var t=this.hasNode();if(t){var e=this.getBounds();return e.width-this.marginLeft-this.marginRight}return 0},getPlotHeight:function(){var t=this.hasNode();if(t){var e=this.getBounds();return e.height-this.marginTop-this.marginBottom}return 0},handleNewData:function(t,e){e.data&&this.redrawGraph(e.data)},redrawGraph:function(t){if(!t.dates||!t.measurements||!t.observations)return this.doError({message:"Missing data, graph cannot be drawn, try again later"}),void 0;var e=this.formatYData(t),a=[t.dates.start,t.dates.end],i=d3.time.scale().domain(a).range([0,this.getPlotWidth()]);this.dateScale=i;var s=d3.time.hours;moment(a[1]).isAfter(moment(a[0]).add("days",1))?(this.scaleOffset=d3.time.day,s=d3.time.days):this.scaleOffset=d3.time.hour,d3.select("svg#wb-graph").remove();var n=d3.select("#"+this.id).append("svg:svg").attr("id","wb-graph").attr("width",this.getPlotWidth()+this.marginLeft+this.marginRight).attr("height",this.getPlotHeight()+this.marginTop+this.marginBottom).append("svg:g").attr("transform","translate("+this.marginRight+","+this.marginTop+")");this.plot=n;var r=d3.svg.axis().scale(i).orient("bottom").ticks(s,1).tickPadding(0).tickSubdivide(0).tickSize(-this.getPlotHeight());n.append("svg:g").attr("class","x_axis").attr("transform","translate(0, "+this.getPlotHeight()+")").call(r).call(enyo.bind(this,this.centerDateLabels)).selectAll("text").style("text-anchor","end").attr("dx","-.3em").attr("dy","0.35em");var o=["left","right"],d=0,h=enyo.bind(this,this.mouseOver),m=enyo.bind(this,this.mouseOut);_.each(e,enyo.bind(this,function(t,e){var a=o[d%2];d++;var s=t.data,r=this.cleanDomain(t.domain),l=d3.scale.linear().domain(r).range([this.getPlotHeight(),0]),u=d3.svg.axis().scale(l).ticks(6).orient(a),c=-this.yAxisOffset,g=c-30,f=-90;"right"==a&&(c=this.yAxisOffset+this.getPlotWidth(),g=c+30,f=90),n.append("svg:g").attr("class","y_axis axis_"+a).attr("transform","translate("+c+", 0)").call(u),n.append("text").attr("class","y_label_"+a).attr("text-anchor","middle").attr("transform","translate("+g+", "+this.getPlotHeight()/2+") rotate("+f+")").text(t.title);var p=n.selectAll(e).data(s).enter().append("circle");p.attr("class","side_"+a).attr("cx",-100).attr("cy",-100).attr("r",this.pointRadius),p.transition().duration(500).each("end",function(){d3.select(this).on("mouseover",function(e,a){var i=d3.select(this);h(e,a,i,t.title,t.unit)}).on("mouseout",function(){m(this)})}).attr("cx",function(t){return i(new Date(t.timestamp))}).attr("cy",function(t){return l(t.value)})}))},mouseOver:function(t,e,a,i,s){var n=parseFloat(a.attr("cx"))+this.marginRight+20,r=parseFloat(a.attr("cy"));d3.time.format("%c");var o=this.$.dataPopup;o.setValue(t.value),o.setTitle(i),o.setUnitLabel(s),o.setMoment(t.timestamp),o.showAtPosition({left:n,top:r}),a.transition().duration(200).attr("r",this.selectedPointRadius)},mouseOut:function(t){this.$.dataPopup.hide(),d3.select(t).transition().duration(200).attr("r",this.pointRadius)},formatYData:function(t){for(var e={},a=0;t.measurements.length>a;a++)e[t.measurements[a]]={};return _.each(t.observations,enyo.bind(this,function(t){t.measurements&&_.each(t.measurements,enyo.bind(this,function(a){var i=a.phenomenon.name;e[i]&&(e[i].title=e[i].title||a.phenomenon.description,e[i].unit=e[i].unit||a.phenomenon.unit.name,e[i].data=e[i].data||[],e[i].data.push({timestamp:t.timestamp,value:a.value}),e[i].domain=e[i].domain||[],e[i].domain.push(a.value))}))})),e},getAxisDates:function(t){var e=moment(t.start),a=moment(t.end),t=[];if(a.isAfter(moment(e).add("days",2)))for(;e.isBefore(a);)t.length>0?t[1]=moment(e).endOf("day").toDate():t.push(moment(e).startOf("day").toDate()),e.add("days",1);return t},centerDateLabels:function(t){t.selectAll(".major text").attr("transform","translate("+this.dayToPixels()/2+",0) rotate(-90)")},dayToPixels:function(){var t=new Date;return this.dateScale(this.scaleOffset.offset(t,1))-this.dateScale(t)},cleanDomain:function(t){var e=1*d3.min(t),a=1*d3.max(t);if(100==a&&e>=0)return[e,a];var i=.1*(a-e);return e-=i,a+=i,[e,a]}});

// ../js/component/GraphControls.js
enyo.kind({name:"wb.GraphControls",published:{from:null,phenomena:null,measurements:[],maxMeasurements:2,startMoment:moment().subtract("days",1).startOf("day"),endMoment:moment().subtract("days",1).endOf("day")},events:{onError:"",onFromChanged:"",onRequestData:""},components:[{classes:"row",components:[{classes:"parameter-block",components:[{content:"From:"},{name:"fromDisplay",classes:"choice-display",ontap:"showPersonPicker",content:"Me"},{tag:"i",ontap:"showPersonPicker",classes:"icon-group elgg-button elgg-button-action"}]},{classes:"parameter-block",name:"startDate",components:[{content:"Start Date:"},{name:"startDateDisplay",classes:"choice-display",ontap:"showCalendar",content:""},{tag:"i",ontap:"showCalendar",classes:"icon-calendar elgg-button elgg-button-action"},{kind:"wb.DatePickCalendar",name:"startDateCalendar",floating:!1,centered:!1,showDatePicker:!1,onSelect:"dateSelected"}]},{classes:"parameter-block",name:"endDate",components:[{content:"End Date:"},{name:"endDateDisplay",classes:"choice-display",ontap:"showCalendar",content:""},{tag:"i",ontap:"showCalendar",classes:"icon-calendar elgg-button elgg-button-action"},{kind:"wb.DatePickCalendar",name:"endDateCalendar",floating:!1,centered:!1,showDatePicker:!1,onSelect:"dateSelected"}]}]},{classes:"row measure",components:[{classes:"parameter-block",components:[{content:"Measurement(s):"},{kind:"enyo.Button",name:"measureButton",ontap:"showMeasurements",content:"Select up to 2"},{kind:"enyo.Popup",name:"measurePopup",showing:!1}]}]},{name:"toolbar",components:[{kind:"enyo.Button",classes:"elgg-button elgg-button-submit",ontap:"showGraph",content:"Show Graph"}]}],create:function(){this.inherited(arguments);var t=new wb.api.PhenomenonCollection;t&&t.fetch&&t.fetch({query:"byUomType",data:{type:"scalar"},success:enyo.bind(this,"setPhenomena")}),this.$.startDateCalendar.setDate(this.startMoment.toDate(),!0),this.$.startDateDisplay.setContent(this.startMoment.format()),this.$.endDateCalendar.setDate(this.endMoment.toDate(),!0),this.$.endDateDisplay.setContent(this.endMoment.format())},phenomenaChanged:function(){this.phenomena.each(function(t){this.$.measurePopup.createComponent({kind:"nbt.Checkbox",text:t.get("description"),value:t.get("name"),checked:!1,ontap:"measurementToggled",owner:this})},this),this.$.measurePopup.createComponent({kind:"enyo.Button",name:"measureHider",ontap:"hideMeasurements",content:"Dismiss"}),this.$.measurePopup.render()},showMeasurements:function(){this.$.measurePopup.show()},hideMeasurements:function(){this.$.measurePopup.hide()},measurementToggled:function(t){if(this.measurements=this.measurements||[],t.checked?_.contains(this.measurements,t.value)||this.measurements.push(t.value):this.measurements=_.without(this.measurements,t.value),this.measurements.length>this.maxMeasurements){this.measurements=_.last(this.measurements,2);var e=this.$.measurePopup.getControls();_.each(e,enyo.bind(this,function(t){"nbt.Checkbox"!=t.kind||_.contains(this.measurements,t.getValue())||t.setChecked(!1)}))}},showPersonPicker:function(t){if($){var e=$("#graph_people");if(1==e.length){var a=t.getBounds(),n=a.left,s=a.top+a.height;e.css("left",n),e.css("top",s),e.show()}}},showCalendar:function(t){var e,a=t.parent.name,n=null;"startDate"==a?(e=this.$.startDateCalendar,n=this.$.endDateCalendar):"endDate"==a&&(e=this.$.endDateCalendar,n=this.$.startDateCalendar),e&&(e.showing?e.hide():e.show()),n&&n.hide()},dateSelected:function(t){if("startDateCalendar"==t.name){var e=moment(t.value).startOf("day");t.value=e.toDate(),this.$.startDateDisplay.setContent(e.format()),this.startMoment=e;var a=moment(this.$.endDateCalendar.getValue());if(a.isBefore(e))a=moment(e).endOf("day"),this.$.endDateCalendar.setDate(a.toDate());else{var n=moment(e).add("months",1).endOf("day");moment(this.$.endDateCalendar.getValue()).isAfter(n)&&this.$.endDateCalendar.setDate(n.toDate())}this.$.startDateCalendar.hide()}else if("endDateCalendar"==t.name){var a=moment(t.value).endOf("day");t.value=a.toDate(),this.$.endDateDisplay.setContent(a.format()),this.endMoment=a;var e=moment(this.$.startDateCalendar.getValue());if(e.isAfter(a))e=moment(a).startOf("day"),this.$.startDateCalendar.setDate(e.toDate());else{var s=moment(a).subtract("months",1).startOf("day");e.isBefore(s)&&this.$.startDateCalendar.setDate(s.toDate())}this.$.endDateCalendar.hide()}},showGraph:function(){if(!this.measurements||0==this.measurements.length)return this.doError({message:"Please select at least 1 measure to be shown"}),void 0;var t={sensorDescriptor:{providerName:"User",sensorId:this.$.pickerButton.getContent()},dateRange:{begin:this.startMoment.unix(),end:this.endMoment.unix()},measurements:this.measurements};this.doRequestData({params:t})},readResponse:function(){data||this.doError({message:"No data found that matches your request, please try again."}),this.doNewData(data)}});

// ../js/component/Checkbox.js
enyo.kind({name:"nbt.Checkbox",classes:"nbt-checkbox",published:{text:"",value:"",checked:!0},events:{ontap:""},components:[{tag:"i",name:"checkbox",classes:"icon-check-empty",ontap:"tapped"},{name:"text",ontap:"tapped"}],create:function(){this.inherited(arguments),this.$.text.setContent(this.text),this.checkedChanged()},tapped:function(){this.setChecked(!this.checked)},checkedChanged:function(){var t=this.$.checkbox;this.checked?(t.removeClass("icon-check-empty"),t.addClass("icon-check")):(t.addClass("icon-check-empty"),t.removeClass("icon-check"))}});

// ../js/component/DatePickCalendar.js
enyo.kind({kind:"onyx.Popup",name:"wb.DatePickCalendar",published:{showDatePicker:!0,value:moment(),monthDisplayFormat:"MMMM"},events:{onSelect:""},centered:!0,floating:!0,scrim:!0,autoDismiss:!0,modal:!0,classes:"calendar-popup",components:[{name:"header",components:[{tag:"i",classes:"icon-circle-arrow-left",ontap:"prevMonth"},{name:"monthDisplay",content:"",showing:!1},{kind:"onyx.DatePicker",onSelect:"doPickerChanged"},{tag:"i",classes:"icon-circle-arrow-right",ontap:"nextMonth"}]},{kind:"CalendarSelector",onDaySet:"doCalendarChanged",onSelect:"selectDate"},{kind:"onyx.Button",content:" Cancel",classes:"icon-remove",ontap:"hide"},{kind:"onyx.Button",content:" Done",classes:"icon-ok",ontap:"doSaveAndHide"}],create:function(){this.inherited(arguments),this.showDatePicker||(this.$.button.hide(),this.$.button2.hide(),this.$.datePicker.hide(),this.$.monthDisplay.show(),this.updateMonthDisplay())},updateMonthDisplay:function(t){t||(t=this.value),this.$.monthDisplay.setContent(moment(t).format(this.monthDisplayFormat))},doCalendarChanged:function(t,e){var a=moment(t.getValue()),n=moment(e.control.getValue());a.isSame(n,"day")&&(_.each(t.getDays(),function(t){t.addRemoveClass("day-selected",!1)},this),e.control.addRemoveClass("day-selected",!0),this.showDatePicker&&this.$.datePicker.setValue(a.toDate()))},setDate:function(t,e){e?(this.value=t,this.$.calendarSelector.setValue(t),this.$.datePicker.setValue(t)):this.$.calendarSelector.calTap({value:t})},selectDate:function(t,e){return this.$.datePicker.setValue(e.value),this.showDatePicker||this.doSaveAndHide(),!0},doPickerChanged:function(t,e){this.$.calendarSelector.setValue(e.value)},nextMonth:function(){if(this.showDatePicker)this.$.calendarSelector.nextMonth();else{var t=moment(this.$.calendarSelector.getValue()).add("months",1);this.$.calendarSelector.setValue(t.toDate()),this.$.monthDisplay.setContent(t.format(this.monthDisplayFormat))}},prevMonth:function(){if(this.showDatePicker)this.$.calendarSelector.prevMonth();else{var t=moment(this.$.calendarSelector.getValue()).subtract("months",1);this.$.calendarSelector.setValue(t.toDate()),this.$.monthDisplay.setContent(t.format(this.monthDisplayFormat))}},doSaveAndHide:function(){this.value=this.$.datePicker.getValue(),this.doSelect({value:this.value}),this.hide()}});

// ../js/component/ModalMessagePopup.js
enyo.kind({name:"nbt.ModalMessagePopup",kind:"onyx.Popup",events:{onOk:"",onCancel:""},floating:!0,centered:!0,modal:!0,components:[{name:"message",allowHtml:!0,content:"Message"},{kind:"enyo.Button",name:"okButton",classes:"btn btn-small",ontap:"popupOk",components:[{tag:"i",classes:"icon-ok"},{content:"Ok"}]},{kind:"enyo.Button",name:"cancelButton",classes:"btn btn-small",ontap:"popupCancel",showing:!1,components:[{tag:"i",classes:"icon-ban-circle"},{content:"Cancel"}]}],showMessage:function(t,e){e=e||{},this.$.message.setContent(t),e.hideOk&&this.$.okButton.hide(),e.cancel&&this.$.cancelButton.show(),this.show()},popupOk:function(t){t.owner.doOk(),t.owner.hide()},popupCancel:function(t){t.owner.doCancel(),t.owner.hide()}});

// ../js/component/DataPopup.js
enyo.kind({name:"nbt.DataPopup",kind:"enyo.Popup",classes:"data_popup",published:{title:"",value:"",unitLabel:"",moment:""},components:[{name:"title"},{classes:"value",components:[{name:"value"},{name:"unit"}]},{name:"date"}],titleChanged:function(){this.$.title.setContent(this.title)},valueChanged:function(){this.$.value.setContent(this.value)},unitLabelChanged:function(){var t=this.convertUnitLabel(this.unitLabel);this.$.unit.setContent(t)},momentChanged:function(){this.$.date.setContent(moment(this.moment).format("ddd, MMM DD YYYY, h:mm:ss a"))},convertUnitLabel:function(t){return"FAHRENHEIT"==t.toUpperCase()?"\u00b0 F":"INCHES"==t.toUpperCase()?'"':t}});

// ../js/App.js
enyo.kind({name:"wb.Graph",published:{data:null,queryUrl:wb.graph.aggregatorUrl+"/observation/query"},components:[{name:"header"},{kind:"wb.GraphView",onError:"showErrorMessage"},{kind:"wb.GraphControls",onRequestData:"doRequestData",onError:"showErrorMessage"},{name:"footer"},{name:"popup",kind:"nbt.ModalMessagePopup"}],showErrorMessage:function(t,e){e.message&&this.$.popup.showMessage(e.message)},dataChanged:function(){this.waterfall("onNewData",{data:this.data})},doRequestData:function(t,e){var a={q:JSON.stringify(e.params)},n=new enyo.Ajax({url:this.queryUrl});n.go(a),n.error(this,function(t){this.showErrorMessage(null,{message:"Error retrieving graphable data ("+t.xhrResponse.status+")"})}),n.response(this,function(t,e){if(!e||"string"==typeof e)return this.showErrorMessage(null,{message:"No data found that matches your request, please try again."}),void 0;var a={dates:{start:this.$.graphControls.startMoment,end:this.$.graphControls.endMoment},measurements:this.$.graphControls.measurements,observations:e};this.setData(a)})}});

// machiapps/CalendarSelector/CalendarSelector.js
enyo.kind({name:"CalendarSelector",classes:"enyo-unselectable",published:{dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],value:new Date,dayColorDefault:"LightSlateGray",dayColorSelected:"Gold",dayColorToday:"GoldenRod",dayColorOtherMonth:"Silver",numberColorThisMonth:"#202020",numberColorOtherMonth:"dimgrey"},events:{onSelect:"",onDaySet:""},components:[{name:"day_names",classes:"top-day-box"},{fit:!0,name:"calVBox",kind:"CalMonth",style:"height: auto;"}],create:function(){this.inherited(arguments);for(var e=0;7>e;e++)this.$.day_names.createComponent({content:this.dayNames[e]})},rendered:function(){this.inherited(arguments),this.updateCalendar()},updateCalendar:function(){this.dayArray=[],this.getDays(),this.fillData()},fillData:function(){for(var e=this.$.calVBox.getControls(),t=0,a=0;e.length>a;a++)for(var n=e[a].getControls(),s=0;n.length>s;s++){n[s].setValue(this.dayArray[t]),n[s].setClassAttribute("");var o=this.getRelativeClass(this.dayArray[t]);n[s].addClass(o),t++,this.doDaySet({control:n[s]})}},getRelativeClass:function(e){if(e.getMonth()<this.value.getMonth())return"prev-month";if(e.getMonth()>this.value.getMonth())return"next-month";var t=new Date;return t.getFullYear()==e.getFullYear()&&t.getDate()==e.getDate()&&t.getMonth()==e.getMonth()?"today":"day"},getColors:function(e){var t=this.dayColorDefault,a=this.numberColorThisMonth,n=(new Date).getDate(),s=(new Date).getMonth(),o=(new Date).getFullYear();return e.getMonth()!=this.value.getMonth()?(t=this.dayColorOtherMonth,a=this.numberColorOtherMonth):this.value.getFullYear()==e.getFullYear()&&this.value.getDate()==e.getDate()&&this.value.getMonth()==e.getMonth()?t=this.dayColorSelected:o==e.getFullYear()&&n==e.getDate()&&s==e.getMonth()&&(t=this.dayColorToday),[t,a]},getDays:function(){var e=new Date(this.value);e.setDate(1);var t=e.getDay(),a=new Date(e);a.setDate(0);var n=a.getDate(),s=new Date(e);s.setMonth(e.getMonth()+1),s.setDate(0);var o=s.getDate(),r=n-t+1;for(i=0;t>i;i++)this.dayArray.push(new Date(a.getFullYear(),a.getMonth(),r,12,0,0)),r++;for(r=1;o>=r;)this.dayArray.push(new Date(s.getFullYear(),s.getMonth(),r,12,0,0)),r++;for(r=1,s.setDate(s.getDate()+1);42>this.dayArray.length;)this.dayArray.push(new Date(s.getFullYear(),s.getMonth(),r,12,0,0)),r++},calTap:function(e){this.value=e.value,this.updateCalendar(),this.doSelect({value:this.value})},setValue:function(e){this.value=new Date(e),this.updateCalendar()},nextMonth:function(){var e=this.value.getDate();this.value.setMonth(this.value.getMonth()+1),e!=this.value.getDate()&&this.value.setDate(0),this.updateCalendar(),this.doSelect({value:this.value})},prevMonth:function(){var e=this.value.getDate();this.value.setMonth(this.value.getMonth()-1),e!=this.value.getDate()&&this.value.setDate(0),this.updateCalendar(),this.doSelect({value:this.value})}}),enyo.kind({name:"CalDay",classes:"day-container",published:{value:{}},events:{onDayPicked:""},handlers:{ontap:"tapMe"},valueChanged:function(){this.setContent(this.value.getDate())},setValue:function(e){this.value=e,this.valueChanged()},tapMe:function(){return this.owner.owner.owner.calTap({value:this.value}),this.doDayPicked({day:this}),!0}}),enyo.kind({name:"CalWeek",classes:"onyx-toolbar-inline week-container",defaultKind:"CalDay",components:[{},{},{},{},{},{},{}]}),enyo.kind({name:"CalMonth",defaultKind:"CalWeek",components:[{},{},{},{},{},{}]});

// initialize.js
$(document).ready(function(){require(["wb/api/main"],function(e){require(["require"],function(){$.ajaxSetup({cache:!0}),app=(new e.Graph).renderInto(document.getElementById("graph_container"))})})});
